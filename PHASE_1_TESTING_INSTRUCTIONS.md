# Phase 1: Feature #2 Testing Instructions

## üéØ **OBJECTIVE**
Apply the database migration and test all Feature #2 components to ensure they work correctly.

---

## üìã **STEP 1: APPLY DATABASE MIGRATION**

### 1.1 Open Supabase SQL Editor

1. **Open your browser** and go to:
   ```
   https://supabase.com/dashboard/project/umywdcihtqfullbostxo/sql
   ```

2. **Log in** to your Supabase account if not already logged in

3. **You should see the SQL Editor** interface

### 1.2 Copy the Migration SQL

1. **Open the migration file** in your code editor:
   ```
   event-management-platform/supabase/migrations/005_qr_code_check_in_enhancements.sql
   ```

2. **Select all content** (Ctrl+A or Cmd+A)

3. **Copy** (Ctrl+C or Cmd+C)

### 1.3 Run the Migration

1. **In the Supabase SQL Editor**, click **"New Query"**

2. **Paste the migration SQL** (Ctrl+V or Cmd+V)

3. **Click "Run"** button (or press Ctrl+Enter)

4. **Wait for completion** - You should see:
   ```
   Success. No rows returned
   ```

5. **Verify the migration** by running this query:
   ```sql
   -- Check if new columns exist
   SELECT column_name 
   FROM information_schema.columns 
   WHERE table_name = 'em_tickets' 
   AND column_name IN ('barcode', 'qr_code_generated_at', 'check_in_count', 'badge_printed');
   ```
   
   **Expected result:** You should see 4 rows with the column names

### 1.4 Verify Tables and Functions

Run these verification queries:

```sql
-- 1. Check offline_sync_queue table exists
SELECT EXISTS (
   SELECT FROM information_schema.tables 
   WHERE table_name = 'offline_sync_queue'
);
-- Expected: true

-- 2. Check check_in_statistics view exists
SELECT EXISTS (
   SELECT FROM information_schema.views 
   WHERE table_name = 'check_in_statistics'
);
-- Expected: true

-- 3. Check process_check_in function exists
SELECT EXISTS (
   SELECT FROM pg_proc 
   WHERE proname = 'process_check_in'
);
-- Expected: true
```

‚úÖ **Migration Complete!** If all queries return `true`, proceed to testing.

---

## üß™ **STEP 2: PREPARE TEST DATA**

### 2.1 Create Test Event (if not exists)

```sql
-- Check if you have an event
SELECT id, title FROM em_events LIMIT 1;
```

If no events exist, create one:

```sql
INSERT INTO em_events (title, description, start_date, end_date, location, status)
VALUES (
  'Test Event for QR Check-in',
  'Testing QR code check-in system',
  NOW() + INTERVAL '1 day',
  NOW() + INTERVAL '2 days',
  'Test Venue',
  'published'
)
RETURNING id, title;
```

**Save the event ID** - you'll need it!

### 2.2 Create Test Ticket Tier

```sql
-- Replace YOUR_EVENT_ID with the event ID from above
INSERT INTO em_ticket_tiers (event_id, name, price, quantity_available)
VALUES (
  'YOUR_EVENT_ID',
  'General Admission',
  0,
  100
)
RETURNING id, name;
```

**Save the ticket tier ID** - you'll need it!

### 2.3 Create Test Ticket

```sql
-- Get your user ID first
SELECT id, email FROM em_profiles WHERE email = 'YOUR_EMAIL' LIMIT 1;

-- Create a test ticket (replace YOUR_USER_ID and YOUR_TICKET_TIER_ID)
INSERT INTO em_tickets (user_id, ticket_tier_id, status, qr_code)
VALUES (
  'YOUR_USER_ID',
  'YOUR_TICKET_TIER_ID',
  'confirmed',
  NULL  -- QR code will be generated by the API
)
RETURNING id;
```

**Save the ticket ID** - you'll use this for testing!

---

## üöÄ **STEP 3: START DEVELOPMENT SERVER**

### 3.1 Open Terminal

Navigate to your project directory:

```bash
cd "d:\event management\event-management-platform"
```

### 3.2 Install Dependencies (if not done)

```bash
npm install
```

### 3.3 Start the Server

```bash
npm run dev
```

**Expected output:**
```
‚ñ≤ Next.js 15.5.4
- Local:        http://localhost:3001
- Environments: .env.local

‚úì Ready in 2.3s
```

‚úÖ **Server is running!** Keep this terminal open.

---

## üß™ **STEP 4: TEST QR CODE GENERATION**

### 4.1 Test QR Code API

Open a new browser tab and navigate to:

```
http://localhost:3001/api/tickets/YOUR_TICKET_ID/qr
```

**Replace `YOUR_TICKET_ID`** with the ticket ID from Step 2.3

**Expected Response:**
```json
{
  "success": true,
  "qrCode": "data:image/png;base64,iVBORw0KG...",
  "ticketId": "your-ticket-id",
  "format": "image"
}
```

### 4.2 View the QR Code

1. **Copy the `qrCode` value** (the entire data URL)
2. **Open a new browser tab**
3. **Paste the data URL** in the address bar
4. **Press Enter**

‚úÖ **You should see a QR code image!**

### 4.3 Save QR Code for Testing

1. **Right-click on the QR code image**
2. **Save image as** `test-qr-code.png`
3. **Save to your desktop** or easily accessible location

---

## üì± **STEP 5: TEST MOBILE SCANNER**

### 5.1 Open Mobile Scanner

Navigate to:
```
http://localhost:3001/check-in/scanner
```

### 5.2 Register Station

1. **Enter station name:** "Test Scanner Station"
2. **Click "Register Station"**

‚úÖ **You should see the scanner interface**

### 5.3 Allow Camera Permissions

1. **Browser will ask for camera permission**
2. **Click "Allow"**

‚úÖ **Camera should activate**

### 5.4 Scan QR Code

**Option A: Display QR on Another Device**
1. Open the QR code image on your phone
2. Point the scanner camera at your phone screen
3. Hold steady 6-12 inches away

**Option B: Print QR Code**
1. Print the saved QR code image
2. Point the scanner camera at the printed QR code

**Expected Result:**
- ‚úÖ QR code is detected
- ‚úÖ Success dialog appears with attendee information
- ‚úÖ Toast notification shows "Check-in successful"

### 5.5 Verify Check-in in Database

Run this query in Supabase SQL Editor:

```sql
-- Check if ticket was checked in
SELECT 
  id,
  checked_in,
  checked_in_at,
  check_in_count
FROM em_tickets 
WHERE id = 'YOUR_TICKET_ID';

-- Check check-in log
SELECT 
  id,
  ticket_id,
  attendee_name,
  attendee_email,
  checked_in_at,
  check_in_method
FROM check_in_logs 
WHERE ticket_id = 'YOUR_TICKET_ID'
ORDER BY checked_in_at DESC
LIMIT 1;
```

**Expected Results:**
- `checked_in` = `true`
- `checked_in_at` = recent timestamp
- `check_in_count` = `1`
- Check-in log entry exists

---

## üñ•Ô∏è **STEP 6: TEST KIOSK INTERFACE**

### 6.1 Open Kiosk

Navigate to:
```
http://localhost:3001/check-in/kiosk
```

‚úÖ **You should see the idle/attract screen**

### 6.2 Start Check-in

1. **Click "Tap to Check In"** button
2. **Camera should activate**

### 6.3 Scan QR Code

**Note:** You'll need a different ticket since the first one is already checked in.

**Create another test ticket:**

```sql
-- In Supabase SQL Editor
INSERT INTO em_tickets (user_id, ticket_tier_id, status, qr_code)
VALUES (
  'YOUR_USER_ID',
  'YOUR_TICKET_TIER_ID',
  'confirmed',
  NULL
)
RETURNING id;
```

1. **Generate QR code** for new ticket: `http://localhost:3001/api/tickets/NEW_TICKET_ID/qr`
2. **Scan the QR code** with kiosk
3. **Observe success screen**
4. **Wait 5 seconds** for auto-reset

‚úÖ **Kiosk should return to idle screen**

---

## üé´ **STEP 7: TEST BADGE PRINT QUEUE**

### 7.1 Open Badge Queue Dashboard

Navigate to:
```
http://localhost:3001/admin/check-in/queue
```

‚úÖ **You should see the badge print queue interface**

### 7.2 Verify Queue is Empty (Initially)

**Expected:**
- Total Pending: 0
- Total Printing: 0
- Total Completed: 0
- Total Failed: 0
- "No print jobs found" message

### 7.3 Create Test Badge Job

Run this in Supabase SQL Editor:

```sql
-- Create a test badge print job
INSERT INTO badge_print_queue (
  ticket_id,
  station_id,
  status,
  priority,
  badge_data
)
SELECT 
  'YOUR_TICKET_ID',
  cs.id,
  'pending',
  1,
  jsonb_build_object(
    'attendee_name', p.full_name,
    'ticket_tier', 'General Admission'
  )
FROM check_in_stations cs
CROSS JOIN em_profiles p
WHERE p.id = 'YOUR_USER_ID'
LIMIT 1
RETURNING id;
```

### 7.4 Refresh Badge Queue Page

1. **Click "Refresh"** button or reload page
2. **Verify badge job appears** in the queue
3. **Check stats cards** show updated counts

‚úÖ **Badge job should be visible in "Pending" tab**

### 7.5 Test Failed Job Retry

```sql
-- Update job to failed status
UPDATE badge_print_queue
SET status = 'failed', error_message = 'Test error'
WHERE id = 'YOUR_BADGE_JOB_ID';
```

1. **Refresh the page**
2. **Go to "Failed" tab**
3. **Click "Retry" button**
4. **Verify status changes to "pending"**

---

## üåê **STEP 8: TEST OFFLINE MODE**

### 8.1 Open Mobile Scanner

```
http://localhost:3001/check-in/scanner
```

### 8.2 Open Browser DevTools

1. **Press F12** (or right-click ‚Üí Inspect)
2. **Go to "Network" tab**
3. **Check "Offline" checkbox** (simulates offline mode)

‚úÖ **Offline indicator should appear** showing "Offline" status

### 8.3 Create Another Test Ticket

```sql
INSERT INTO em_tickets (user_id, ticket_tier_id, status, qr_code)
VALUES ('YOUR_USER_ID', 'YOUR_TICKET_TIER_ID', 'confirmed', NULL)
RETURNING id;
```

### 8.4 Scan QR Code While Offline

1. **Generate QR code** for new ticket
2. **Scan the QR code**
3. **Observe behavior:**
   - ‚úÖ Toast shows "Check-in queued (offline)"
   - ‚úÖ Pending count increases
   - ‚úÖ Check-in is saved to IndexedDB

### 8.5 Verify IndexedDB Storage

1. **In DevTools, go to "Application" tab**
2. **Expand "IndexedDB"**
3. **Find "EventCheckInDB"**
4. **Click on "checkIns" store**

‚úÖ **You should see the queued check-in record**

### 8.6 Test Sync When Back Online

1. **Uncheck "Offline" in Network tab**
2. **Wait 30 seconds** for auto-sync OR **click "Sync Now"**
3. **Observe:**
   - ‚úÖ Pending count decreases to 0
   - ‚úÖ Toast shows "Synced X check-ins"
   - ‚úÖ Check-in appears in database

### 8.7 Verify Sync in Database

```sql
SELECT * FROM check_in_logs 
WHERE ticket_id = 'YOUR_OFFLINE_TICKET_ID'
AND is_offline_sync = true;
```

‚úÖ **Check-in log should exist with `is_offline_sync = true`**

---

## ‚úÖ **STEP 9: VERIFICATION CHECKLIST**

Mark each item as you complete it:

- [ ] Database migration applied successfully
- [ ] Test data created (event, ticket tier, tickets)
- [ ] Development server running
- [ ] QR code generation works
- [ ] Mobile scanner loads and camera activates
- [ ] QR code scanning works (online mode)
- [ ] Check-in is recorded in database
- [ ] Kiosk interface works
- [ ] Kiosk auto-resets after check-in
- [ ] Badge print queue displays correctly
- [ ] Badge job retry works
- [ ] Offline mode indicator appears
- [ ] Offline check-in queues to IndexedDB
- [ ] Sync works when back online
- [ ] Offline check-in appears in database

---

## üêõ **TROUBLESHOOTING**

### Issue: Camera Not Working

**Solutions:**
- Ensure you're on `localhost` (HTTPS not required for localhost)
- Try Chrome or Edge browser
- Check browser permissions (Settings ‚Üí Privacy ‚Üí Camera)
- Restart browser

### Issue: QR Code Not Scanning

**Solutions:**
- Ensure good lighting
- Hold QR code steady 6-12 inches from camera
- Try adjusting angle
- Verify QR code is valid (check API response)

### Issue: "Unauthorized" Error

**Solutions:**
- Ensure you're logged in
- Check Supabase auth token
- Try logging out and back in

### Issue: Database Errors

**Solutions:**
- Verify migration was applied
- Check table/column names match
- Verify RLS policies allow access

---

## üìù **REPORT ISSUES**

If you encounter any issues:

1. **Note the error message**
2. **Check browser console** (F12 ‚Üí Console tab)
3. **Check terminal** for server errors
4. **Take screenshots** if helpful
5. **Share with me** for troubleshooting

---

## üéâ **NEXT STEPS**

Once all tests pass:

1. ‚úÖ Mark Feature #2 as tested and working
2. üöÄ Proceed to Phase 2: Complete Feature #3 implementation

---

**Last Updated:** 2025-10-03  
**Status:** Ready for testing

